<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Camera Settings</title>
<style>
* {
    box-sizing: border-box;
}
html {
    font-size: 16px;
}
body {
    margin: 0;
    padding: 0;
    font-size: 1rem;
}
.container {
    padding: 0 1rem 2rem 1rem; 
    margin: auto;
    max-width: 100%; 
    overflow: hidden;
}
@media (min-width: 800px) {
    html {
        font-size: 20px;
    }
    .container {
        max-width: 800px; 
    }
}
.section {
    width: 100%; 
}
.section_title {
    width: 100%;
    height: 2.5rem; 
    font-size: 1.3rem; 
    padding: 0.5rem; 
    margin: 0.5rem 0;
    text-align: center;
    font-weight: bold;
    color: #333; 
    background-color: #E8F6F3;
}
.section_row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    justify-content: right;
    width: 100%; 
    height: 2.5rem; 
    padding: 0.25rem 0; 
    /* border: 1px solid red;  */
}
input, select {
    flex-grow: 1;
    flex-shrink: 1; 
    min-width: 6rem;
    height: 2rem; 
    font-size: 1rem; 
} 
button {
    flex-grow: 0;
    flex-shrink: 0;
    width:6rem; 
    height:2rem;
    font-size: 1rem; 
    font-weight: normal;
}
.big_button {
    width: 7rem;
}
label, input {
    white-space: nowrap;
}
.center {
    justify-content: center;
}

.status-row {
  align-items: center; /* Vertically align items */
  padding: 10px;
  margin-bottom: 5px;
  border-radius: 5px;
  color: white;
}

.success {
  background-color: #4CAF50; /* Green */
}

.warning {
  background-color: #ff9800; /* Orange */
}

.error {
  background-color: #f44336; /* Red */
}

.close-btn {
  margin-left: 10px;
  background-color: transparent;
  border: none;
  color: white;
  font-weight: bold;
  cursor: pointer;
  font-size: 1.2em;
}
</style>
</head>
<body>
<div class="container">
    <div class="section">
        <div class="section_title">WiFi AP</div>
        <div id="wifi_ap_message"></div>
        <div class="section_row">
            <label for="ap_ssid">SSID</label>
            <input type="text" id="ap_ssid" value="LiveCamera" readonly>
        </div>
        <div class="section_row">
            <label for="ap_pwd">Password</label>
            <input type="text" id="ap_pwd" value="password" readonly>
        </div>
        <div class="section_row">
            <label for="ap_ip">IP</label>
            <input type="text" id="ap_ip" value="10.0.0.1" readonly>
        </div>
        <div class="section_row">
            <button id="update_ap" onclick="update_ap()">Update</button>
        </div>
    </div>
    <div class="section">
        <div class="section_title">WiFi STA</div>
        <div id="wifi_sta_message"></div>
        <div class="section_row">
            <label for="wifi_ssid">SSID</label>
            <input type="text" id="wifi_ssid" value="">
        </div>
        <div class="section_row">
            <label for="wifi_pwd">Password</label>
            <input type="text" id="wifi_pwd" value="">
        </div>
        <div class="section_row">
            <label for="wifi_ip">IP</label>
            <input type="text" id="wifi_ip" value="" readonly>
        </div>
        <div class="section_row">
            <button id="update_wifi" onclick="update_wifi()">Update</button>
        </div>
    </div>
    <div class="section">
        <div class="section_title">Ethernet</div>
        <div id="ethernet_message"></div>
        <div class="section_row">
            <label for="eth_ip">IP</label>
            <input type="text" id="eth_ip" value="" readonly> 
            <button id="check_ethernet" onclick="check_ethernet()">Check</button>
        </div>
    </div>
    <div class="section">
        <div class="section_title">Video Settings</div>
        <div id="vodeo_message"></div>
        <div class="section_row">
            <label for="video_res">Resolution</label>
            <select id="video_res">
                <option value="640,480">640x480 (4:3)</option>
                <option value="1280,720">1280x720 (16:9)</option>
                <option value="1920,1080">1920x1080 (16:9)</option>
            </select>
        </div>
        <div class="section_row">
            <label for="video_af_mode">AF Mode</label>
            <select id="video_af_mode">
                <option value="0">Manual</option>
                <option value="1">Auto</option>
                <option value="2">Continuous</option>
            </select>
        </div>
        <div class="section_row">
            <label for="video_bright">Brightness</label>
            <input type="text" id="video_bright" value="1">
        </div>
        <div class="section_row">
            <button id="setup_camera" onclick="setup_camera()">Apply</button>
        </div>
    </div>
    <div class="section">
        <div class="section_title">Software Versions</div>
        <div id="software_message"></div>
        <div class="section_row">
            <label for="installed_version">Current Version</label>
            <input type="text" id="installed_version" value="" readonly>
            <button id="check_software_versions" onclick="check_software_versions()">Check</button>
        </div>
        <div class="section_row">
            <label for="latest_version">Latest Version</label>
            <input type="text" id="latest_version" value=""> 
            <button id="install_latest_software" onclick="install_latest_software()">Install</button>
        </div>
        <div class="section_row">
            <label for="fallback_version">Fallback Version</label>
            <input type="text" id="fallback_version" value=""> 
            <button id="install_fallback_software" onclick="install_fallback_software()">Install</button>
        </div>
    </div>
    <div class="section">
        <div class="section_title">System Status</div>
        <div id="system_message"></div>
        <div class="section_row center">
            <button class="big_button" id="restart_system" onclick="restart_system()">Restart</button>
            <button class="big_button" id="shutdow_system" onclick="shutdown_system()">Shutdown</button>
        </div>
    </div>
</div>
<script>
    var hostname = window.location.hostname;
    var url = "ws://" + hostname + ":8090/camera"
    var ws = new WebSocket(url);
    ws.onopen = (event) => {
        console.log("WebSocket connection opened:", event);
    };

    ws.onclose = (event) => {
        console.log("WebSocket connection closed:", event);
    };

    ws.onerror = (error) => {
        console.error("WebSocket error:", error);
    };

    ws.onmessage = (event) => {
        console.log("received: " + event.data) 
        var response = JSON.parse(event.data); 
        handle_response(response)
    };

    function send_message(message) {
        var data = JSON.stringify(message); 
        console.log("send: " + data)
        ws.send(data); 
    }

    // response table 
    var id = 0; 
    const result_handlers = new Map();
    const error_handlers = new Map(); 

    function handle_response(response) {
        id = "id" in response ? response.id : null;  
        if ("result" in response && result_handlers.has(id)) {
            result_handlers.get(id)(response.result)
            result_handlers.delete(id) 
        }
        if ("error" in response && error_handlers.has(id)) {
            error_handlers.get(id)(response.error) 
            error_handlers.delete(id)
        }
    }

    function popup_message(element_id, type, message) {
        const statusMessagesContainer = document.getElementById(element_id);

        // Create a new div element for the status row
        const statusRow = document.createElement('div');
        statusRow.classList.add('status-row', type); // Add the base class and the type class
        statusRow.textContent = message; // Set the message text

        // Create the close button
        const closeButton = document.createElement('button');
        closeButton.classList.add('close-btn');
        closeButton.textContent = 'Ã—'; // Unicode for the 'times' or 'x' symbol

        // Attach an event listener to the close button
        closeButton.onclick = function() {
            statusMessagesContainer.removeChild(statusRow); // Remove the entire row when the button is clicked
        };

        // Append the close button to the status row
        statusRow.appendChild(closeButton);

        // Append the status row to the container
        statusMessagesContainer.appendChild(statusRow);
    }

    function check_software_versions() {
        id++;
        result_handlers.set(id, update_software_versions) 
        var request = { "method": "check_software_versions", "id": id };
        send_message(request);
    }

    function update_software_versions(versions) {
        console.log(versions)
        document.getElementById("installed_version").value = versions.installed_version; 
        document.getElementById("latest_version").value = versions.latest_version; 
        document.getElementById("fallback_version").value = versions.fallback_version; 
    }

    function install_latest_software() {
        id++;
        error_handlers.set(id, popup_software_error) 
        version = document.getElementById("latest_version").value 
        console.log("latest_version: " + version)
        var request = { "method": "install_software", "params": { "version": version }, "id": id };
        send_message(request);
    }
    
    function install_fallback_software() {
        id++;
        error_handlers.set(id, popup_software_error) 
        version = document.getElementById("fallback_version").value 
        console.log("fallback_version: " + version)
        var request = { "method": "install_software", "params": { "version": version }, "id": id };
        send_message(request);
    }

    function popup_software_error(error) {
        console.warn(error)
    }


    function check_system_status() {

    }

    function update_system_status() {

    }

    function restart_system() {
        id++;
        error_handlers.set(id, popup_system_error) 
        var request = { "method": "restart_system", "id": id };
        send_message(request);
    }

    function shutdown_system() {
        id++;
        error_handlers.set(id, popup_system_error) 
        var request = { "method": "shutdown_system", "id": id };
        send_message(request);
    }

    function popup_system_error(error) {
        console.warn(error)
    }

    function check_ethernet_status() {
        id++;
        result_handlers.set(id, update_ethernet_status) 
        var request = { "method": "check_ethernet_status", "id": id };
        send_message(request);
    }

    function update_ethernet_status(ipv4) {
        console.log(ipv4)
        document.getElementById("ethernet_ip").value = ipv4.address; 
    }

    function setup_ethernet() {

    }

    function check_wifi_sta_status() {
        id++;
        result_handlers.set(id, update_wifi_sta_status) 
        var request = { "method": "check_wifi_sta_status", "id": id };
        send_message(request);
    }

    function update_wifi_sta_status(wifi) {
        console.log(ipv4)
    }

    function setup_wifi_sta() {

    }

    function check_wifi_ap_status() {
        id++;
        result_handlers.set(id, update_wifi_ap_status) 
        var request = { "method": "check_wifi_ap_status", "id": id };
        send_message(request);
    }

    function update_wifi_ap_status(wifi) {
        console.log(wifi)

    }

    function setup_wifi_ap() {

    }

    function check_video_settings() {

    }

    function update_video_settings(settings) {

    }

    function setup_video() {

    }

    function setup_video_resolution() {

    }

    function setup_video_fps() {

    }
</script>
</body>
</html>
